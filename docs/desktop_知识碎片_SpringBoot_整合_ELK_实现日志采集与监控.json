{"data": "# SpringBoot \u6574\u5408 ELK \u5b9e\u73b0\u65e5\u5fd7\u91c7\u96c6\u4e0e\u76d1\u63a7\n\n> \u4f5c\u8005\uff1a[A\u8fbe\u8fbe](https://music.163.com/#/user/home?id=1711732324)\uff0c[\u7f16\u7a0b\u5bfc\u822a\u661f\u7403](https://wx.zsxq.com/dweb2/index/group/51122858222824) \u7f16\u53f7 19158\n\nspringboot\u9879\u76ee\u901a\u8fc7logback\u6846\u67b6\u5c06\u65e5\u5fd7\u901a\u8fc7logstash\u7ba1\u9053\u4f20\u8f93\u5230ElasticSearch,\u5e76\u901a\u8fc7kibbna\u8fdb\u884c\u53ef\u89c6\u5316\n\n**\u4e00\u3001\u524d\u8a00**\n\n```markdown\n\u5e94\u7528\u573a\u666f\uff1a  \n1. Web\u5e94\u7528\u65e5\u5fd7\u76d1\u63a7\uff1a\u901a\u8fc7Spring Boot\u7684\u65e5\u5fd7\u6a21\u5757\u5c06\u5e94\u7528\u7684\u65e5\u5fd7\u4fe1\u606f\u6536\u96c6\u8d77\u6765\uff0c\u5e76\u901a\u8fc7Logstash\u6a21\u5757\u8fdb\u884c\u89e3\u6790\u548c\u8fc7\u6ee4\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u4fe1\u606f\u5b58\u50a8\u5230Elasticsearch\u4e2d\uff0c\u6700\u540e\u901a\u8fc7Kibana\u6a21\u5757\u5c55\u793a\u65e5\u5fd7\u4fe1\u606f\u548c\u76d1\u63a7\u6307\u6807\u3002  \n2. \u7cfb\u7edf\u6027\u80fd\u76d1\u63a7\uff1a\u901a\u8fc7Spring Boot\u7684\u76d1\u63a7\u6a21\u5757\u5c06\u5e94\u7528\u7684\u6027\u80fd\u6307\u6807\u6536\u96c6\u8d77\u6765\uff0c\u5982CPU\u4f7f\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u7387\u3001\u7f51\u7edc\u6d41\u91cf\u7b49\uff0c\u7136\u540e\u901a\u8fc7Logstash\u6a21\u5757\u8fdb\u884c\u89e3\u6790\u548c\u8fc7\u6ee4\uff0c\u6700\u540e\u5c06\u76d1\u63a7\u4fe1\u606f\u5b58\u50a8\u5230Elasticsearch\u4e2d\uff0c\u901a\u8fc7Kibana\u6a21\u5757\u5c55\u793a\u76d1\u63a7\u4fe1\u606f\u548c\u751f\u6210\u62a5\u8868\u3002  \n3. \u9519\u8bef\u4fe1\u606f\u76d1\u63a7\uff1a\u901a\u8fc7Spring Boot\u7684\u5f02\u5e38\u5904\u7406\u6a21\u5757\u5c06\u5e94\u7528\u7684\u9519\u8bef\u4fe1\u606f\u6536\u96c6\u8d77\u6765\uff0c\u5982Exception\u4fe1\u606f\u3001HTTP\u8bf7\u6c42\u4fe1\u606f\u7b49\uff0c\u7136\u540e\u901a\u8fc7Logstash\u6a21\u5757\u8fdb\u884c\u89e3\u6790\u548c\u8fc7\u6ee4\uff0c\u6700\u540e\u5c06\u9519\u8bef\u4fe1\u606f\u5b58\u50a8\u5230Elasticsearch\u4e2d\uff0c\u901a\u8fc7Kibana\u6a21\u5757\u5c55\u793a\u9519\u8bef\u4fe1\u606f\u548c\u751f\u6210\u62a5\u8868\u3002  \n\u4f18\u70b9\uff1a  \n1. \u7075\u6d3b\u6027\u9ad8\uff1aSpring Boot\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u65e5\u5fd7\u6a21\u5757\u548c\u76d1\u63a7\u6a21\u5757\uff0c\u53ef\u4ee5\u6839\u636e\u5177\u4f53\u9700\u6c42\u9009\u62e9\u5408\u9002\u7684\u6a21\u5757\u8fdb\u884c\u96c6\u6210\u548c\u914d\u7f6e\uff0c\u5177\u6709\u9ad8\u5ea6\u7684\u7075\u6d3b\u6027\u3002  \n2. \u6613\u4e8e\u4f7f\u7528\uff1aSpring Boot\u63d0\u4f9b\u4e86\u7b80\u5316\u914d\u7f6e\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e9b\u6ce8\u89e3\u548c\u5c5e\u6027\u6587\u4ef6\u6765\u914d\u7f6e\u65e5\u5fd7\u548c\u76d1\u63a7\u6a21\u5757\uff0c\u964d\u4f4e\u4e86\u914d\u7f6e\u7684\u590d\u6742\u5ea6\uff0c\u6613\u4e8e\u4f7f\u7528\u3002  \n3. \u529f\u80fd\u5f3a\u5927\uff1aELK\u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u65e5\u5fd7\u7ba1\u7406\u548c\u76d1\u63a7\u5de5\u5177\uff0c\u53ef\u4ee5\u5b9e\u73b0\u65e5\u5fd7\u7684\u91c7\u96c6\u3001\u5b58\u50a8\u3001\u641c\u7d22\u548c\u5206\u6790\u7b49\u529f\u80fd\uff0c\u652f\u6301\u751f\u6210\u62a5\u8868\u548c\u5b9e\u65f6\u76d1\u63a7\uff0c\u53ef\u4ee5\u6ee1\u8db3\u5404\u79cd\u65e5\u5fd7\u548c\u76d1\u63a7\u9700\u6c42\u3002  \n4. \u6269\u5c55\u6027\u5f3a\uff1aSpring Boot\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u6269\u5c55\u70b9\uff0c\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6\u548c\u63d2\u4ef6\u6765\u6269\u5c55\u65e5\u5fd7\u548c\u76d1\u63a7\u529f\u80fd\uff0c\u6ee1\u8db3\u7279\u5b9a\u7684\u4e1a\u52a1\u9700\u6c42\u3002\n```\n\n\u4e8c\u3001\u73af\u5883\u642d\u5efa\n\n```\nwindows\u73af\u5883:\n```\n\n1. \u4e0b\u8f7delasticSearch logstash kibbna \u4e14\u5fc5\u987b\u7248\u672c\u7edf\u4e00 \u5c06\u5176\u89e3\u538b\u5230\u82f1\u6587\u8def\u5f84\u4e0b\n\n   \u4e0b\u8f7d\u5b98\u7f51\u94fe\u63a5\uff1a[\u4e0b\u8f7d Elastic \u4ea7\u54c1 | Elastic](https://www.elastic.co/cn/downloads/)\n\n2. \u914d\u7f6eELK\n\n```stylus\n1.elasticSearch \uff08\u7aef\u53e39200\uff09\na.\u914d\u7f6eelasticsearch.yml\n#\u53bb\u9664\u62a5\u9519\ningest.geoip.downloader.enabled: false\n#\u5f00\u542f\u5bc6\u7801\nxpack.security.transport.ssl.enabled: true\nxpack.security.enabled: true\nxpack.license.self_generated.type: basic\nb.bin\u76ee\u5f55\u4e0b\u6267\u884c\u4e3a\u591a\u4e2a\u7528\u6237\u8bbe\u7f6e\u5bc6\u7801\nelasticsearch-setup-passwords interactive\nc.bin\u76ee\u5f55\u4e0b\u53cc\u51fbelasticsearch.bat\u6587\u4ef6\u542f\u52a8\n2.kibbna\uff08\u7aef\u53e35601\uff09\na.\u914d\u7f6ekibbna.yml\u8fde\u63a5ES\nelasticsearch.username: \"elastic\"\nelasticsearch.password: \"xxxxx\"\nb.bin\u76ee\u5f55\u4e0b\u53cc\u51fbkibbna.bat\u6587\u4ef6\u542f\u52a8\n3.logstash\uff08\u7aef\u53e39600\uff09\na.config\u76ee\u5f55\u521b\u5efa\u81ea\u5df1\u7684\u542f\u52a8\u914d\u7f6e\u6587\u4ef6 logstash-meter.conf \uff08\u540d\u79f0\u81ea\u5b9a\u4e49\uff09\ninput{\n        tcp {\n                mode => \"server\"\n                host => \"0.0.0.0\" \n                port => 9061 #\u5f00\u653e\u8fd9\u4e2a\u7aef\u53e3\u8fdb\u884c\u91c7\u96c6\n                codec => json_lines # \u7f16\u89e3\u7801\u5668\n    }\n}\n# \u8fc7\u6ee4\u5668\nfilter {\n    ruby { \n        code => \"event.set('timestamp', event.get('@timestamp').time.localtime + 8*60*60)\" \n    }\n\n    ruby {\n        code => \"event.set('@timestamp',event.get('timestamp'))\"\n    }\n# \u5ffd\u7565\u5b57\u6bb5\n        mutate {\n    remove_field => [\"timestamp\",\"@version\",\"host\",\"port\"]\n        }\n}\noutput{\n        elasticsearch{\n                hosts=>[\"ipaddress:9200\"]\n                # \u5728es\u91cc\u4ea7\u751f\u7684index\u7684\u540d\u79f0\n                index => \"logstash-meter-%{+YYYY.MM.dd}\"\n                user  => \"elastic\"\n                password  => \"xxxx\"\n               template_name => \"logstash-meter-template\"\n                }\n        stdout{codec => rubydebug}\n}\nb.bin\u76ee\u5f55\u4e0b\u6267\u884c logstash -f ../config/logstash-meter.conf\n```\n\n`linus\u73af\u5883:`docker\u90e8\u7f72\n\n```jboss-cli\n1.\u5b89\u88c5docker\n#yum \u5305\u66f4\u65b0\u5230\u6700\u65b0\nyum update\n#\u5b89\u88c5\u9700\u8981\u7684\u8f6f\u4ef6\u5305\uff0c yum-util \u63d0\u4f9byum-config-manager\u529f\u80fd\uff0c\u53e6\u5916\u4e24\u4e2a\u662fdevicemapper\u9a71\u52a8\u4f9d\u8d56\u7684\nyum install -y yum-utils device-mapper-persistent-data lvm2\n#\u8bbe\u7f6eyum\u6e90\nyum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n#\u5b89\u88c5docker\uff0c\u51fa\u73b0\u8f93\u5165\u7684\u754c\u9762\u90fd\u6309 y\nyum install -y docker-ce\n#\u67e5\u770bdocker\u7248\u672c\uff0c\u9a8c\u8bc1\u662f\u5426\u9a8c\u8bc1\u6210\u529f\ndocker -v\n#\u542f\u52a8docker\n/bin/systemctl start docker.service\n\n2.\u62c9\u53d6elasticSearch logstash kibbna\ndocker pull elasticsearch:7.6.0    \ndocker pull logstash:7.6.0    \ndocker pull kibana:7.6.0\n\n3.\u5f00\u653e9061\u7aef\u53e3 \u7528\u8fd9\u4e2a\u7aef\u53e3\u8ba9\u65e5\u5fd7\u901a\u8fc7logstash\u7ba1\u9053\u4fdd\u5b58\u5230es\u4e2d \u5e76\u901a\u8fc7kibbna\u53ef\u89c6\u5316\nfirewall-cmd --query-port=9061/tcp\nfirewall-cmd --zone=public --add-port=9061/tcp --permanent \u5f00\u542f\nfirewall-cmd --zone=public --remove-port=9200/tcp --permanent \u5173\u95ed\nfirewall-cmd --reload\n---------------------------------------------------------------------------\n4.\u542f\u52a8elasticSearch logstash kibbna\ndocker run -id \\\n-p 9200:9200 \\\n--name=elasticsearch \\\n-v /etc/localtime:/etc/localtime \\\n-e \"discovery.type=single-node\" \\\nelasticsearch:7.6.0\n---------------------------------------------------------------------------\ndocker run -id \\\n-p 5601:5601 \\\n--name=kibana \\\n-v /etc/localtime:/etc/localtime \\\nkibana:7.6.0\n---------------------------------------------------------------------------\ndocker run -id \\\n-p 9600:9600 \\\n-p 9061:9061 \\\n--name=logstash \\\n-v /etc/localtime:/etc/localtime \\\nlogstash:7.6.0\n---------------------------------------------------------------------------\n5.\u914d\u7f6eelasticSearch logstash kibbna\ndocker exec -it elasticsearch /bin/bash\nvi config/elasticsearch.yml\n\u589e\u52a0\nxpack.security.transport.ssl.enabled: true\nxpack.security.enabled: true\nxpack.license.self_generated.type: basic\n\u91cd\u542felasticsearch \u5f00\u542f\u5bc6\u7801\nelasticsearch-setup-passwords interactive\n---------------------------------------------------------------------------\ndocker exec -it kibana /bin/bash\nvi config/kibana.yml\nelasticsearch.username: \"elastic\"\nelasticsearch.password: \"xxxxx\"\n---------------------------------------------------------------------------\ndocker exec -it kibana /bin/bash\nvi config/logstash.yml\n#\u5141\u8bb8\u4efb\u4f55\u4e3b\u673a\u8fde\u63a5 \nhttp.host: \"0.0.0.0\"\nxpack.monitoring.enabled: true\nxpack.monitoring.elasticsearch.username: \"elastic\"\nxpack.monitoring.elasticsearch.password: \"xxxxx\"\n#\u6267\u884cdocker inspect elasticSearch \u627e\u5230ipAddress \nxpack.monitoring.elasticsearch.hosts: [ \"http://ipAddress:9200\" ]\n\n#\u7f16\u5199logstash.conf\u914d\u7f6e\n#\u914d\u7f6e \u6570\u636e\u6765\u6e90  \u8fc7\u6ee4\u5668 \u8f93\u51fa\u914d\u7f6e\u7b49\u4fe1\u606f\ninput{\n        tcp {\n                mode => \"server\"\n                host => \"0.0.0.0\" \n                port => 9061 #\u5f00\u653e\u8fd9\u4e2a\u7aef\u53e3\u8fdb\u884c\u91c7\u96c6\n                codec => json_lines # \u7f16\u89e3\u7801\u5668\n    }\n}\n# \u8fc7\u6ee4\u5668\nfilter {\n    ruby { \n        code => \"event.set('timestamp', event.get('@timestamp').time.localtime + 8*60*60)\" \n    }\n\n    ruby {\n        code => \"event.set('@timestamp',event.get('timestamp'))\"\n    }\n# \u5ffd\u7565\u5b57\u6bb5\n        mutate {\n    remove_field => [\"timestamp\",\"@version\",\"host\",\"port\"]\n        }\n}\noutput{\n        elasticsearch{\n                hosts=>[\"ipaddress:9200\"]\n                # \u5728es\u91cc\u4ea7\u751f\u7684index\u7684\u540d\u79f0\n                index => \"logstash-meter-%{+YYYY.MM.dd}\"\n                user  => \"elastic\"\n                password  => \"xxxx\"\n               template_name => \"logstash-meter-template\"\n                }\n        stdout{codec => rubydebug}\n}\n#\u7136\u540e\u4fee\u6539pipeline\u6307\u5b9aconf \u6216 \u628aconf\u653e\u5230pipeline\u6587\u4ef6\u5939\u4e0b\n```\n\n\u4e09\u3001**springboot\u914d\u7f6e\uff08logback.xml\u914d\u7f6e\uff09**\n\npom.xml\u5f15\u5165maven\u4f9d\u8d56\n\n```dust\n//\u63d0\u4f9blogback\u7684\u7f16\u7801\u5668\uff0c\u5e03\u5c40\uff08layouts\uff09\u548c\u8ffd\u52a0\u5668\uff0c\u6765\u8f93\u51fa\u5230json\u5f62\u5f0f\u7684\u65e5\u5fd7\u3002\n<dependency>\n    <groupId>net.logstash.logback</groupId>\n    <artifactId>logstash-logback-encoder</artifactId>\n    <version>${logstash-logback-encoder.version}</version>\n</dependency>\n```\n\n\u914d\u7f6elogback.xml\u6587\u4ef6 \u6307\u5b9a\u65e5\u5fd7\u8f93\u51fa\u5230logstash\u7684\u7aef\u53e3\u53f7\n\n```dust\n<!-- \u4e3alogstash\u8f93\u51fa\u7684JSON\u683c\u5f0f\u7684Appender -->\n<appender name=\"logstash\" class=\"net.logstash.logback.appender.LogstashTcpSocketAppender\">\n    <!--\u53ef\u4ee5\u8bbf\u95ee\u7684logstash\u65e5\u5fd7\u6536\u96c6\u7aef\u53e3-->\n    <destination>127.0.0.1:9061</destination>\n    <!-- \u65e5\u5fd7\u8f93\u51faJson\u7f16\u7801 -->\n    <encoder\n            class=\"net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder\">\n        <providers>\n            <timestamp>\n                <timeZone>UTC</timeZone>\n            </timestamp>\n            <pattern>\n                <pattern>\n                    {\n                    \"ip\":\"%ip\",\n                    \"serverName\":\"${serverName}\",\n                    \"thread\": \"%thread\",\n                    \"level\": \"%-5level\",\n                    \"logger\": \"%logger{36}\",\n                    \"message\": \"%msg\"\n                    }\n                </pattern>\n            </pattern>\n        </providers>\n    </encoder>\n</appender>\n<root level=\"INFO\">\n    <appender-ref ref=\"logstash\" />\n</root>\n```\n\n\u56db\u3001**kibbna\u53ef\u89c6\u5316\u914d\u7f6e**\n\n1. \u542f\u52a8elasticSearch \u548c kibbna \u6253\u5f00kibbna\u7f51\u7ad9 localhost:5601 \u8f93\u5165\u8bbe\u7f6e\u7684\u8d26\u53f7\u5bc6\u7801\u767b\u5f55\u8ba4\u8bc1\u540e\u8fdb\u5165\u53ef\u89c6\u5316\u9875\u9762\uff0c\u53cc\u51fbDEV tools \u8f93\u5165\u4e0b\u65b9sql \u521b\u5efa\u6a21\u677f(\u542f\u52a8logstash\u4e4b\u524d\uff09\n\n```awk\n//\u65b0\u5efa\u6a21\u677f\nPUT /_template/logstash-meter-template\n{         \n  \"index_patterns\": [\"logstash-meter-*\"],\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 1\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"message\": {\n        \"type\": \"text\"\n        , \"analyzer\": \"ik_max_word\"\n        , \"search_analyzer\": \"ik_smart\"\n        , \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\"\n          }\n        }\n      },\n\n      \"ip\": {\n        \"type\": \"keyword\"\n      },\n      \"serverName\": {\n        \"type\": \"keyword\"\n      },\n      \"thread\": {\n        \"type\": \"keyword\"\n      },\n      \"level\": {\n        \"type\": \"keyword\"\n      },\n      \"logger\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n--------------------------------------------------------------------------------\n//\u641c\u7d22\u6d4b\u8bd5\nget /logstash-meter-*/_doc/_search\n{\n  \"query\":{\n    \"match\": {\n      \"message\": {\n        \"query\":\"xxx\"\n      }\n    }\n  }\n}\n```\n\n2.\u521b\u5efaindexpattern\uff0c\u540d\u79f0\u8bbe\u4e3alogstash-meter-*\uff0c\u548c\u4e0a\u9762logstash.conf\u4e2dindex\u7684\u524d\u7f00\u5339\u914d\u5373\u53ef\n\n3.\u542f\u52a8springboot\u9879\u76ee \u548c logstash \uff0c\u6b64\u65f6\u53d1\u73b0logstash\u4e2d\u4f1a\u6253\u5370springboot\u9879\u76ee\u4e2d\u7684\u65e5\u5fd7\uff0c\u7136\u540e\u5728kibbna\u4e2d\u627e\u5230discovery\u5373\u53ef\u53ef\u89c6\u5316\u65e5\u5fd7\u4fe1\u606f\uff0c\u8fd8\u53ef\u5bf9\u5176\u8fc7\u6ee4\u5904\u7406\uff0c\u5feb\u901f\u5b9a\u4f4d\u5230\u6211\u4eec\u9700\u8981\u7684\u65e5\u5fd7\u3002"}