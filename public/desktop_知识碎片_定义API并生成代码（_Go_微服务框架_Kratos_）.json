{"data": "# \u5b9a\u4e49API\u5e76\u751f\u6210\u4ee3\u7801\uff08 Go \u5fae\u670d\u52a1\u6846\u67b6 Kratos \uff09\n\n> \u4f5c\u8005\uff1a[\u620a\u5b50\u4ef2\u79cb](https://github.com/wuzizhongqiu/wuzi-study-note#%E6%88%8A%E5%AD%90%E4%BB%B2%E7%A7%8B%E7%9A%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%88%86%E4%BA%AB)\uff0c[\u7f16\u7a0b\u5bfc\u822a\u661f\u7403](https://wx.zsxq.com/dweb2/index/group/51122858222824) \u7f16\u53f7 20000\n\n\u9996\u5148\uff1a kratos new study\n\n\u6211\u901a\u8fc7\u7528 kratos \u5b98\u65b9\u7ed9\u7684\u6a21\u677f\u521b\u5efa\u4e00\u4e2a\u53eb study \u7684\u9879\u76ee\uff08\u540d\u5b57\u968f\u610f\uff09\n\n## \u5982\u4f55\u8dd1\u901a\u6574\u4e2a\u6d41\u7a0b\uff1f\n\n\u770b\u5b98\u65b9\u6587\u6863\uff1a\u901a\u8fc7\u5b9a\u4e49 proto \u5373\u53ef\u4f7f\u7528 REST API \u548c RPC API\n\n\u7b2c\u4e00\u6b65\uff0c\u5b9a\u4e49\u597d\u6211\u4eec\u7684 proto \u6587\u4ef6\n\n\u6211\u4eec\u53ef\u4ee5\u7528\u5b98\u65b9\u7ed9\u51fa\u7684\u4ee3\u7801\u6a21\u677f\u751f\u6210\u4e00\u4e2a\u6a21\u677f\uff0c\u6bd4\u5982\u8bf4\uff0c\u6211\u60f3\u5b9e\u73b0\u4e00\u4e2a todo \u6e05\u5355\u7684\u589e\u5220\u6539\u67e5\uff1a\n\n```shell\nkratos proto add api/study/v1/todo.proto\n```\n\n\u4ed6\u751f\u6210\u4e86\u4e00\u4e2a proto \u6587\u4ef6\uff0c\u6211\u4eec\u6839\u636e\u9700\u8981\u53bb\u4fee\u6539\u5c31\u884c\uff1a\n\n```protobuf\nservice Todo {\n\trpc CreateTodo (CreateTodoRequest) returns (CreateTodoReply);\n\trpc UpdateTodo (UpdateTodoRequest) returns (UpdateTodoReply);\n\trpc DeleteTodo (DeleteTodoRequest) returns (DeleteTodoReply);\n\trpc GetTodo (GetTodoRequest) returns (GetTodoReply);\n\trpc ListTodo (ListTodoRequest) returns (ListTodoReply);\n}\n\nmessage CreateTodoRequest {}\nmessage CreateTodoReply {}\n\nmessage UpdateTodoRequest {}\nmessage UpdateTodoReply {}\n\nmessage DeleteTodoRequest {}\nmessage DeleteTodoReply {}\n\nmessage GetTodoRequest {}\nmessage GetTodoReply {}\n\nmessage ListTodoRequest {}\nmessage ListTodoReply {}\n```\n\n\u8fd9\u91cc\u6211\u4eec\u5c31\u5b9e\u73b0\u6a21\u677f\u7ed9\u7684 5 \u4e2a\u63a5\u53e3\uff1a\n\n```protobuf\nimport \"google/api/annotations.proto\"; // \u9700\u8981\u5f15\u5165\n\nservice Todo {\n\trpc CreateTodo (CreateTodoRequest) returns (CreateTodoReply) {\n\t\toption (google.api.http) = { // http \u65b9\u6cd5\n\t\t\tpost: \"/v1/todo/create\",\n\t\t\tbody: \"*\"\n\t\t};\n\t};\n\trpc UpdateTodo (UpdateTodoRequest) returns (UpdateTodoReply) {\n\t\toption (google.api.http) = {\n\t\t\tpost: \"/v1/todo/update/{id}\",\n\t\t\tbody: \"*\"\n\t\t};\n\t};\n\trpc DeleteTodo (DeleteTodoRequest) returns (DeleteTodoReply) {\n\t\toption (google.api.http) = {\n\t\t\tpost: \"/v1/todo/delete/{id}\",\n\t\t\tbody: \"*\"\n\t\t};\n\t};\n\trpc GetTodo (GetTodoRequest) returns (GetTodoReply) {\n\t\toption (google.api.http) = {\n\t\t\tget: \"/v1/todo/get/{id}\",\n\t\t};\n\t};\n\trpc ListTodo (ListTodoRequest) returns (ListTodoReply) {\n\t\toption (google.api.http) = {\n\t\t\tget: \"/v1/todo/list\",\n\t\t};\n\t};\n}\n\nmessage todo {\n\tint64 id = 1;\n\tstring title = 2;\n\tbool status = 3;\n}\n\nmessage CreateTodoRequest { // \u53d1\u9001\u7ed9\u524d\u7aef\u7684\u8bf7\u6c42\u53c2\u6570\n\tstring title = 1;\n}\nmessage CreateTodoReply { // \u4ece\u524d\u7aef\u63a5\u6536\u7684\u8fd4\u56de\u53c2\u6570\n\tint64 id = 1;\n\tstring title = 2;\n\tbool status = 3;\n}\n\nmessage UpdateTodoRequest {\n\tint64 id = 1;\n\tstring title = 2;\n\tbool status = 3;\n}\nmessage UpdateTodoReply {}\n\nmessage DeleteTodoRequest {\n\tint64 id = 1;\n}\nmessage DeleteTodoReply {}\n\nmessage GetTodoRequest {\n\tint64 id = 1;\n}\nmessage GetTodoReply {\n\ttodo todo = 1;\n}\n\nmessage ListTodoRequest {}\nmessage ListTodoReply {\n\trepeated todo data = 1;\n}\n```\n\n\u7136\u540e\u751f\u6210 go \u4ee3\u7801\uff1b\n\n```shell\nkratos proto client api/study/v1/todo.proto\n```\n\n\u5f53\u770b\u5230\u8fd9\u91cc\u7684 go \u4ee3\u7801\u6210\u529f\u751f\u6210\u4e86\uff0c\u5c31\u8bc1\u660e\u6ca1\u4ec0\u4e48\u95ee\u9898\uff1a\n\n![](https://pic.yupi.icu/5563/202401011502181.png)\n\n\u6211\u4eec\u7ee7\u7eed\u751f\u6210 service \u7aef\u4ee3\u7801\uff1a\n\n```awk\nkratos proto server api/study/v1/todo.proto -t internal/service\n```\n\n\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u5c31\u591a\u4e86\u4e00\u4e2a todo.go \u7684\u4ee3\u7801\u4e86\n\n![](https://pic.yupi.icu/5563/202401011502242.png)\n\n\u90a3 service \u5c42\u7684\u8fd9\u4e2a todo.go \u5e94\u8be5\u5b9e\u73b0\u4e00\u4e9b\u4ec0\u4e48\u4e1c\u897f\u5462\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u770b\u770b\u793a\u4f8b\u7684 greater.go \u5b9e\u73b0\u4e86\u4ec0\u4e48\uff0c\u4ed6\u8fd9\u91cc\u5d4c\u5165\u4e86\u4e00\u4e2a\u5b9e\u73b0\u4e1a\u52a1\u903b\u8f91\u7684\u7ed3\u6784\u4f53\uff0c\u5728 biz \u91cc\u9762\u7684\n\n![](https://pic.yupi.icu/5563/202401011502315.png)\n\n\u7136\u540e\u4e0b\u9762\u5c31\u662f\u5177\u4f53\u903b\u8f91\u7684\u5b9e\u73b0\uff1a\n\n![](https://pic.yupi.icu/5563/202401011502297.png)\n\n\u90a3\u54b1\u4eec\u4e5f\u7167\u846b\u82a6\u753b\u74e2\uff0c\u540c\u6837\u6574\u4e00\u4efd\uff1a\n\n```go\ntype TodoService struct {\n\tpb.UnimplementedTodoServer\n\n\t// \u5d4c\u5165\u4e00\u4e2a\u5b9e\u73b0\u4e1a\u52a1\u903b\u8f91\u7684\u7ed3\u6784\u4f53\uff08biz\uff09\n\tuc *biz.TodoUsecase\n}\n\nfunc NewTodoService(uc *biz.TodoUsecase) *TodoService {\n\t// \u5728\u8fd9\u91cc\u9700\u8981\u521d\u59cb\u5316, \u4f20\u5165 uc\n\treturn &TodoService{\n\t\tuc: uc,\n\t}\n}\n```\n\n![](https://pic.yupi.icu/5563/202401011502234.png)\n\nbiz \u8fd9\u91cc\uff0c\u54b1\u4eec CV \u4ed6\u7684 greater.go \u4ee3\u7801\uff0c\u81ea\u5df1\u5b9e\u73b0\u4e00\u4efd\u6211\u4eec\u7684 todo.go\uff0c\n\n\u6839\u636e\u6211\u4eec\u524d\u9762\u5b9a\u4e49\u7684 proto \u6587\u4ef6\uff0c\u5b9a\u4e49\u597d Todo \u7684\u7ed3\u6784\u4f53\uff0c\u7136\u540e\u60f3\u4e00\u60f3\u6211\u4eec\u9700\u8981 data \u5c42\u5b9e\u73b0\u4ec0\u4e48\u529f\u80fd\uff0c\n\n\u6700\u540e\u5c31\u662f\u5b9e\u73b0\u6211\u4eec\u7684 CreateTodo\uff0c\u7ed9 service \u63d0\u4f9b\u4e00\u4e2a\u521b\u5efa\u7684\u65b9\u6cd5\n\n```go\n// Todo is a Greeter model.\ntype Todo struct {\n\tID     int64\n\tTitle  string\n\tStatus bool\n}\n\n// TodoRepo \u5c01\u88c5\u7684\u662f\u9700\u8981\u6570\u636e\u64cd\u4f5c\u5c42\u7ed9\u6211\u7684\u5b9e\u73b0\u7684\u64cd\u4f5c\uff08biz \u5c42\u5bf9 data \u5c42\u63d0\u51fa\u4e86\u8fd9\u4e9b\u8981\u6c42\uff09\ntype TodoRepo interface {\n\tSave(context.Context, *Todo) (*Todo, error)\n\tUpdate(context.Context, *Todo) error\n\tDelete(context.Context, int64) error\n\tFindByID(context.Context, int64) (*Todo, error)\n\tListAll(context.Context) ([]*Todo, error)\n}\n\n// TodoUsecase is a Greeter usecase.\ntype TodoUsecase struct {\n\trepo TodoRepo\n\tlog  *log.Helper\n}\n\n// NewTodoUsecase new a Greeter usecase.\nfunc NewTodoUsecase(repo TodoRepo, logger log.Logger) *TodoUsecase {\n\treturn &TodoUsecase{repo: repo, log: log.NewHelper(logger)}\n}\n\n// CreateTodo \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Todo\n// \u5bf9\u5916\u63d0\u4f9b\u7684\u7684\u4e1a\u52a1\u51fd\u6570, \u5177\u4f53\u6765\u8bf4\u5c31\u662f service \u5c42\u8c03\u7528\u4ed6\nfunc (uc *TodoUsecase) CreateTodo(ctx context.Context, t *Todo) (*Todo, error) {\n\tuc.log.WithContext(ctx).Infof(\"CreateTodo: %v\", t)\n\treturn uc.repo.Save(ctx, t) // \u8c03\u7528\u4e0b\u4e00\u5c42\u7684 Save\n}\n```\n\n\u63a5\u7740\uff0c\u6211\u4eec\u56de\u5230 service \u5c42\uff0c\u54b1\u4eec\u5148\u5b9e\u73b0\u4e00\u4e2a\u903b\u8f91\u7684 demo\uff0c\u7136\u540e\u8ba9\u7a0b\u5e8f\u5feb\u901f\u8dd1\u8d77\u6765\uff1a\n\n```go\nfunc (s *TodoService) CreateTodo(ctx context.Context, req *pb.CreateTodoRequest) (*pb.CreateTodoReply, error) {\n\t// \u8bf7\u6c42\u6765\u4e86\n\tif len(req.GetTitle()) == 0 {\n\t\treturn &pb.CreateTodoReply{}, fmt.Errorf(\"\u65e0\u6548\u7684title\")\n\t}\n\t// \u8c03\u7528\u4e1a\u52a1\u903b\u8f91\n\tdata, err := s.uc.CreateTodo(ctx, &biz.Todo{\n\t\tTitle: req.Title,\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\t// \u8fd4\u56de\u54cd\u5e94\n\treturn &pb.CreateTodoReply{\n\t\tId:     data.ID,\n\t\tTitle:  data.Title,\n\t\tStatus: data.Status,\n\t}, nil\n}\n```\n\n\u6211\u4eec\u5728 biz \u5c42\u7ed9 data \u5c42\u63d0\u4e86\u8981\u6c42\uff0c\u90a3\u6211\u4eec\u5c31\u9700\u8981\u53bb\u5b9e\u73b0\u4e00\u4e0b\uff0c\n\n\u540c\u6837\u7684\u64cd\u4f5c\uff0cCV \u4e00\u4efd greater.go \u7684\u4ee3\u7801\uff0c\u7136\u540e\u4fee\u6539\u6211\u4eec\u7684 todo.go\n\n![](https://pic.yupi.icu/5563/202401011502300.png)\n\n\u628a\u6211\u4eec\u4e4b\u524d\u5728 biz \u5c42\u5c01\u88c5\u7684\u529f\u80fd\u90fd\u5199\u597d\u5728\u8fd9\u91cc\n\n```go\ntype todoRepo struct {\n\tdata *Data\n\tlog  *log.Helper\n}\n\n// NewtodoRepo .\nfunc NewtodoRepo(data *Data, logger log.Logger) biz.TodoRepo {\n\treturn &todoRepo{\n\t\tdata: data,\n\t\tlog:  log.NewHelper(logger),\n\t}\n}\n\nfunc (r *todoRepo) Save(ctx context.Context, t *biz.Todo) (*biz.Todo, error) {\n\tfmt.Printf(\"save: t: %v\\n\", t)\n\t// \u5b9e\u73b0\u6570\u636e\u5e93\u64cd\u4f5c\n\treturn t, nil\n}\n\nfunc (r *todoRepo) Update(ctx context.Context, t *biz.Todo) error {\n\treturn nil\n}\n\nfunc (r *todoRepo) Delete(ctx context.Context, id int64) error {\n\treturn nil\n}\n\nfunc (r *todoRepo) FindByID(ctx context.Context, id int64) (*biz.Todo, error) {\n\treturn nil, nil\n}\n\nfunc (r *todoRepo) ListAll(context.Context) ([]*biz.Todo, error) {\n\treturn nil, nil\n}\n```\n\n\u8fd9\u91cc\u6682\u65f6\u5148\u4e0d\u5199\u5177\u4f53\u7684\u903b\u8f91\uff0c\u5982\u679c\u9700\u8981\u64cd\u4f5c\u6570\u636e\u5e93\uff0c\u90a3\u5c31\u8981\u5230 data.go \u6587\u4ef6\u8fde\u63a5\u6211\u4eec\u7684\u6570\u636e\u5e93\uff0c\u6211\u4eec\u5148\u628a\u9879\u76ee\u8dd1\u8d77\u6765\uff0c\u6682\u65f6\u5148\u4e0d\u7ba1\n\n\u6700\u540e\uff0c\u6211\u4eec\u903b\u8f91\u5b9e\u73b0\u5b8c\u4e86\uff0c\u522b\u4eba\u600e\u4e48\u8c03\u7528\u6211\u4eec\u7684\u670d\u52a1\u5462\uff1f\u8fd9\u65f6\u5019\u5c31\u8981\u5230 server \u5c42\u6ce8\u518c\u670d\u52a1\uff0cgrpc.go\uff1a\n\n```go\nimport (\n\tv1 \"study/api/study/v1\" // \u6ce8\u610f\u8981 import study\n\t\"study/internal/conf\"\n\t\"study/internal/service\"\n\n\t\"github.com/go-kratos/kratos/v2/log\"\n\t\"github.com/go-kratos/kratos/v2/middleware/recovery\"\n\t\"github.com/go-kratos/kratos/v2/transport/grpc\"\n)\n\n// NewGRPCServer new a gRPC server.\nfunc NewGRPCServer(c *conf.Server, todo *service.TodoService, logger log.Logger) *grpc.Server {\n\tvar opts = []grpc.ServerOption{\n\t\tgrpc.Middleware(\n\t\t\trecovery.Recovery(),\n\t\t),\n\t}\n\tif c.Grpc.Network != \"\" {\n\t\topts = append(opts, grpc.Network(c.Grpc.Network))\n\t}\n\tif c.Grpc.Addr != \"\" {\n\t\topts = append(opts, grpc.Address(c.Grpc.Addr))\n\t}\n\tif c.Grpc.Timeout != nil {\n\t\topts = append(opts, grpc.Timeout(c.Grpc.Timeout.AsDuration()))\n\t}\n\tsrv := grpc.NewServer(opts...)\n\tv1.RegisterTodoServer(srv, todo)\n\treturn srv\n}\n```\n\nhttp.go \u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u8fd9\u91cc\u5c31\u4e0d\u653e\u4ee3\u7801\u4e86\n\n\u6700\u540e\u5230 cmd \u76ee\u5f55\u4e0b\u7684 wire.go \u6587\u4ef6\uff1a\n\n![](https://pic.yupi.icu/5563/202401011502409.png)\n\n\u5c06\u8fd9\u91cc wire.Build \u91cc\u9762\u7684\u51fd\u6570\uff0c\u70b9\u8fdb\u4ed6\u4eec\u7684\u5b9e\u73b0\uff0c\u7136\u540e\u4fee\u6539\u6210\u6211\u4eec\u7684\u903b\u8f91\uff0c\u6bd4\u5982\u8fdb data.ProviderSet\uff1a\n\n```go\nvar ProviderSet = wire.NewSet(NewData, NewtodoRepo)\n```\n\n\u6539\u6210 NewtodoRepo\uff0c\u5176\u4ed6\u7684\u4e5f\u7c7b\u4f3c\uff0c\u7136\u540e\u8fdb\u5165\u5230 wire.go \u5728\u7684\u76ee\u5f55\uff0c\u6267\u884c wire\uff1a\n\n```ebnf\nwire\n```\n\n\u751f\u6210\u65b0\u7684 wire_gen.go \u4ee3\u7801\n\n\u6700\u540e\uff0c\u4e00\u5207\u90fd\u51c6\u5907\u5c31\u7eea\uff0c\u6211\u4eec\u56de\u5230\u4e3b\u8def\u5f84\uff0c\u5c06\u9879\u76ee\u8dd1\u8d77\u6765\uff1a\n\n```routeros\nkratos run\n```\n\n![](https://pic.yupi.icu/5563/202401011502562.png)\n\n![](https://pic.yupi.icu/5563/202401011502549.png)\n\n\u9879\u76ee\u5c31\u6210\u529f\u8dd1\u8d77\u6765\u4e86"}